"""
Display Mapper - Vulnerability Scanner Template

This mapper formats vulnerability data for UI display. It generates:
- Description: Explains what the control evaluates
- Tag: Quick summary shown in lists (e.g., "Critical (5), High (12)")
- Violations: Column definitions for violation display (optional)

See CUSTOMIZATION.md for detailed guidance on customizing this mapper.
"""


def main(occurrence, attestation, context):
    """
    Format vulnerability data for UI display.

    Args:
        occurrence: Occurrence with mapped detail from detail.py
        attestation: Policy configuration and evaluation results
        context: Execution context

    Returns:
        dict: Display configuration with description, tag, and optionally violations
    """
    # TODO: Customize this description to match your tool
    _description = (
        "Security vulnerability scanner evaluates scan results against "
        "policy-defined thresholds for each severity level (critical, high, "
        "medium, low). "
        "\n\n"
        "The policy supports:\n"
        "- Maximum vulnerability counts per severity level\n"
        "- Exception lists (CVE/CWE IDs to exclude)\n"
        "- Location exclusions (file paths/directories to ignore)\n"
        "\n"
        "Violations are recorded for vulnerabilities exceeding thresholds "
        "that are not in the exception list."
    )

    # Extract detail data from occurrence
    # This data comes from detail.py mapper output
    _detail = occurrence.get('detail', {})
    _summary = _detail.get('summary', {})
    _scan = _detail.get('scan', {})

    # Extract counts from summary
    critical = _summary.get('critical', 0)
    high = _summary.get('high', 0)
    medium = _summary.get('medium', 0)
    low = _summary.get('low', 0)
    total = _summary.get('total', 0)

    # TODO: Customize the tag to show the most relevant summary
    # Here are some common tag formats:

    # Option 1: Show critical and high only (most common)
    _tag = f'Critical ({critical}), High ({high})'

    # Option 2: Show all severity levels
    # _tag = f'Critical: {critical}, High: {high}, Medium: {medium}, Low: {low}'

    # Option 3: Show total count
    # _tag = f'{total} Total Vulnerabilities'

    # Option 4: Show scan metadata
    # scan_id = _scan.get('id', 'N/A')
    # _tag = f'Scan {scan_id}: C:{critical} H:{high} M:{medium} L:{low}'

    # Option 5: Show timestamp
    # timestamp = _scan.get('timestamp', 'Unknown')
    # _tag = f'Scan from {timestamp} - C:{critical} H:{high}'

    return {
        'description': _description,
        'tag': _tag
    }

    # Optional: Add violation column definitions
    # Uncomment this to show violations in the UI
    #
    # return {
    #     'description': _description,
    #     'tag': _tag,
    #     'violations': {
    #         'columns': {
    #             # Severity level
    #             'level': {
    #                 'name': 'Severity',
    #                 'type': 'string'
    #             },
    #             # Vulnerability identifier (CVE, CWE, rule ID)
    #             'identifier': {
    #                 'name': 'ID',
    #                 'type': 'string'
    #             },
    #             # Description/message
    #             'description': {
    #                 'name': 'Description',
    #                 'type': 'string'
    #             },
    #             # CWE list
    #             'cwe': {
    #                 'name': 'CWE',
    #                 'type': 'string'  # Will show as JSON array
    #             },
    #             # Categories
    #             'categories': {
    #                 'name': 'Categories',
    #                 'type': 'string'  # Will show as JSON array
    #             },
    #             # Priority score
    #             'priority': {
    #                 'name': 'Priority',
    #                 'type': 'number'
    #             },
    #             # File path (first location)
    #             'locations.0.file': {
    #                 'name': 'File',
    #                 'type': 'string'
    #             },
    #             # Line number (first location)
    #             'locations.0.startLine': {
    #                 'name': 'Line',
    #                 'type': 'number'
    #             }
    #         }
    #     }
    # }


# For local testing
if __name__ == '__main__':
    import sys
    import json

    # Load test occurrence and attestation
    if len(sys.argv) > 2:
        with open(sys.argv[1]) as f:
            test_occurrence = json.load(f)
        with open(sys.argv[2]) as f:
            test_attestation = json.load(f)
    else:
        print("Usage: python display.py <occurrence.json> <attestation.json>")
        sys.exit(1)

    # Run mapper
    result = main(test_occurrence, test_attestation, {})

    # Print formatted result
    print(json.dumps(result, indent=2))
