# Deployment with Validation Workflow
#
# This workflow adds validation and testing stages before deployment.
# This is the RECOMMENDED approach for production deployments.
# Uses direct script calls for portability.
#
# Pipeline stages:
#   1. Validate - File structure, syntax, schema validation
#   2. Test - Run mapper tests (pytest) and Rego tests (OPA)
#   3. Package - Bundle controls
#   4. Deploy - Push to Fianu environment
#
# Usage:
#   - Copy to .github/workflows/deploy-with-validation.yml
#   - Configure secrets
#   - Update CONTROLS variable

name: Deploy Controls - With Validation

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  # List of controls to deploy (space-separated)
  CONTROLS_DIR: "controls"

jobs:
  # ============================================================================
  # Stage 1: Validate
  # ============================================================================
  validate:
    name: Validate Controls
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install PyYAML

      - name: Make validation scripts executable
        run: |
          chmod +x examples/testing/validation/*.sh

      - name: Validate all controls
        run: |
          ./examples/testing/validation/validate-all.sh

  # ============================================================================
  # Stage 2: Test
  # ============================================================================
  test:
    name: Test Controls
    runs-on: ubuntu-latest
    needs: validate  # Only run if validation passes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install testing dependencies
        run: |
          pip install -r examples/testing/mappers/requirements.txt

      - name: Run mapper tests
        run: |
          cd examples/testing/mappers
          pytest --cov=../../mappers --cov-report=term --cov-report=xml

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Run Rego tests
        run: |
          # Find all controls with rule tests
          for control_dir in */; do
            if [ -f "$control_dir/rule/rule.rego" ] && [ -f "$control_dir/rule/rule_test.rego" ]; then
              echo "Testing $control_dir"
              cd "$control_dir/rule"
              opa test -v rule.rego rule_test.rego
              cd ../..
            fi
          done

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          flags: mappers

  # ============================================================================
  # Stage 3: Package & Deploy
  # ============================================================================
  deploy:
    name: Package and Deploy
    runs-on: ubuntu-latest
    needs: test  # Only run if tests pass
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Fianu CLI
        uses: fianulabs/actions@main
        with:
          version: ${{ secrets.FIANU_VERSION }}

      - name: Package controls
        run: |
          echo "Packaging controls: $CONTROLS_DIR"
          ./scripts/package-all.sh $CONTROLS_DIR

      - name: Upload packages as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: control-packages
          path: 'dist/*.tgz'
          retention-days: 7

      - name: Deploy controls
        env:
          FIANU_CLIENT_ID: ${{ secrets.FIANU_DEV_CLIENT_ID }}
          FIANU_CLIENT_SECRET: ${{ secrets.FIANU_DEV_CLIENT_SECRET }}
          FIANU_HOST: https://fianu-dev.fianu.io
        run: |
          echo "Deploying to $FIANU_HOST"
          ./scripts/apply-all.sh dist/

      - name: Check deployment status
        if: failure()
        run: |
          echo "::error::Deployment failed. Check logs above for details."
          exit 1

  # ============================================================================
  # Summary (runs on PRs)
  # ============================================================================
  summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [validate, test]
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const summary = `## Validation & Test Summary

            ✅ **Validation:** Passed
            ✅ **Mapper Tests:** Passed
            ✅ **Rego Tests:** Passed

            Ready to merge and deploy!
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
