# Multi-Environment Deployment Workflow
#
# This workflow demonstrates deploying controls through multiple environments
# with approval gates and environment-specific configurations.
# Uses direct script calls for portability.
#
# Promotion Flow:
#   DEV (automatic) → QA (automatic) → PROD (manual approval)
#
# Features:
#   - Automatic deployment to dev on push to main
#   - Automatic deployment to qa after dev succeeds
#   - Manual approval required for prod
#   - Environment-specific secrets
#   - Full validation and testing before each environment

name: Deploy - Multi-Environment

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod

env:
  # List of controls to deploy (space-separated)
  CONTROLS_DIR: "controls"

jobs:
  # ============================================================================
  # Validation and Testing (runs once for all environments)
  # ============================================================================
  validate-and-test:
    name: Validate and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyYAML
          pip install -r examples/testing/mappers/requirements.txt

      - name: Validate controls
        run: |
          chmod +x examples/testing/validation/*.sh
          ./examples/testing/validation/validate-all.sh

      - name: Run mapper tests
        run: |
          cd examples/testing/mappers
          pytest --cov=../../mappers --cov-report=term

      - name: Install OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/

      - name: Run Rego tests
        run: |
          for control_dir in */; do
            if [ -f "$control_dir/rule/rule.rego" ] && [ -f "$control_dir/rule/rule_test.rego" ]; then
              echo "Testing $control_dir"
              cd "$control_dir/rule"
              opa test -v rule.rego rule_test.rego
              cd ../..
            fi
          done

  # ============================================================================
  # Deploy to DEV
  # ============================================================================
  deploy-dev:
    name: Deploy to DEV
    runs-on: ubuntu-latest
    needs: validate-and-test
    if: github.event_name == 'push' || github.event.inputs.environment == 'dev'

    environment:
      name: dev
      url: https://fianu-dev.fianu.io

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Fianu CLI
        uses: fianulabs/actions@main
        with:
          version: ${{ secrets.FIANU_VERSION }}

      - name: Package controls
        run: |
          echo "Packaging controls: $CONTROLS_DIR"
          ./scripts/package-all.sh $CONTROLS_DIR

      - name: Deploy to DEV
        env:
          FIANU_CLIENT_ID: ${{ secrets.FIANU_DEV_CLIENT_ID }}
          FIANU_CLIENT_SECRET: ${{ secrets.FIANU_DEV_CLIENT_SECRET }}
          FIANU_HOST: https://fianu-dev.fianu.io
        run: |
          echo "Deploying to DEV: $FIANU_HOST"
          ./scripts/apply-all.sh dist/

  # ============================================================================
  # Deploy to QA
  # ============================================================================
  deploy-qa:
    name: Deploy to QA
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: success() && (github.event_name == 'push' || github.event.inputs.environment == 'qa')

    environment:
      name: qa
      url: https://fianu-qa.fianu.io

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Fianu CLI
        uses: fianulabs/actions@main
        with:
          version: ${{ secrets.FIANU_VERSION }}

      - name: Package controls
        run: |
          echo "Packaging controls: $CONTROLS_DIR"
          ./scripts/package-all.sh $CONTROLS_DIR

      - name: Deploy to QA
        env:
          FIANU_CLIENT_ID: ${{ secrets.FIANU_QA_CLIENT_ID }}
          FIANU_CLIENT_SECRET: ${{ secrets.FIANU_QA_CLIENT_SECRET }}
          FIANU_HOST: https://fianu-qa.fianu.io
        run: |
          echo "Deploying to QA: $FIANU_HOST"
          ./scripts/apply-all.sh dist/

  # ============================================================================
  # Deploy to PROD (Manual Approval Required)
  # ============================================================================
  deploy-prod:
    name: Deploy to PROD
    runs-on: ubuntu-latest
    needs: deploy-qa
    if: success() && (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')

    environment:
      name: prod
      url: https://app.fianu.io

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Fianu CLI
        uses: fianulabs/actions@main
        with:
          version: ${{ secrets.FIANU_VERSION }}

      - name: Package controls
        run: |
          echo "Packaging controls: $CONTROLS_DIR"
          ./scripts/package-all.sh $CONTROLS_DIR

      - name: Deploy to PROD
        env:
          FIANU_CLIENT_ID: ${{ secrets.PROD_FIANU_CLIENT_ID }}
          FIANU_CLIENT_SECRET: ${{ secrets.PROD_FIANU_CLIENT_SECRET }}
          FIANU_HOST: https://app.fianu.io
        run: |
          echo "Deploying to PRODUCTION: $FIANU_HOST"
          # Slower rate limit for prod (configured in apply-all.sh or override here)
          ./scripts/apply-all.sh dist/

      - name: Create release tag
        if: success()
        run: |
          TAG="release-$(date +%Y%m%d-%H%M%S)"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG" -m "Production release: $TAG"
          git push origin "$TAG"

  # ============================================================================
  # Notify
  # ============================================================================
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-qa, deploy-prod]
    if: always()

    steps:
      - name: Send notification
        run: |
          echo "Deployment completed!"
          echo "DEV: ${{ needs.deploy-dev.result }}"
          echo "QA: ${{ needs.deploy-qa.result }}"
          echo "PROD: ${{ needs.deploy-prod.result }}"

          # Add Slack/email notification here
          # Example:
          # curl -X POST $SLACK_WEBHOOK \
          #   -d '{"text":"Deployment: DEV=${{ needs.deploy-dev.result }}, QA=${{ needs.deploy-qa.result }}, PROD=${{ needs.deploy-prod.result }}"}'
