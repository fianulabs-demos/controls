# Basic Deployment Workflow
#
# This workflow demonstrates a simple deployment pattern for Fianu official controls.
# Uses direct script calls instead of custom actions for portability.
#
# Triggers:
#   - Push to main branch
#   - Manual workflow dispatch
#
# What it does:
#   1. Checks out code
#   2. Sets up Fianu CLI
#   3. Packages controls using ../../../scripts/package-all.sh
#   4. Deploys using ../../../scripts/apply-all.sh
#
# Usage:
#   - Copy to .github/workflows/deploy-dev.yml
#   - Configure secrets: FIANU_DEV_CLIENT_ID, FIANU_DEV_CLIENT_SECRET
#   - Update CONTROLS variable with your control paths

name: Deploy Controls - Basic

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  # List of controls to deploy (space-separated)
  CONTROLS: "ci.commit.codereview snyk.sast.vulnerabilities"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup Fianu CLI
      - name: Setup Fianu CLI
        uses: fianulabs/actions@main
        with:
          version: ${{ secrets.FIANU_VERSION }}

      # 3. Package controls
      - name: Package controls
        run: |
          echo "Packaging controls: $CONTROLS"
          ./scripts/package-all.sh $CONTROLS

      # 4. Deploy controls
      - name: Deploy controls
        env:
          FIANU_CLIENT_ID: ${{ secrets.FIANU_DEV_CLIENT_ID }}
          FIANU_CLIENT_SECRET: ${{ secrets.FIANU_DEV_CLIENT_SECRET }}
          FIANU_HOST: https://fianu-dev.fianu.io
        run: |
          echo "Deploying to $FIANU_HOST"
          ./scripts/apply-all.sh dist/

      # 5. Check deployment status
      - name: Check deployment status
        if: failure()
        run: |
          echo "::error::Deployment failed. Check logs above for details."
          exit 1
